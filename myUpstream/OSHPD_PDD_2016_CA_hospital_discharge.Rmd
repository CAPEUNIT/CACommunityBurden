---
title: "OSHPD_PDD_diabetes"
author: "Carolina Downie"
date: "February 27, 2019"
output: html_document
---

#Packages
Loading packages necessary for this analysis
```{r loading packages}
library(tidyverse)
library(ggplot2)
library(haven)
library(fs)
library(readxl)
```

#Creating 2016 OSHPD PDD dataset from OSHPD sas7bdat file, subsetting our variables of interest
Note: This code should only be run once, to read in the original 2016 OSHPD PDD datafile and then create a subset with only the data of interest. This data will then be stored as an rds file in the subsequent code, which is what should be run in the future. 
```{r defining file paths}
myDrive <- "H:"  #Change this the drive where your data is located--in my case, the H: drive
myPlace <- paste0(myDrive,"/0.CBD/myCBD") 
upPlace <- paste0(myDrive,"/0.CBD/myUpstream")
```

Reading in OSHPD sas file using haven, and selecting variables of interest. 
Diagnosis Variables:
* diag_p = primary diagnosis
* odiag1 - odiag24 = other diagnoses
* mdc = major diagnostic categories, formed by dividing all possible principal diagnoses into 25 mutually exclusive diagnosis groupings. Definitions of the 25 groups are located in the myInfo/App_I_MDC_PDD.xlsx file. 
Cost-related Variables:
* charge = 
* pay_cat = type of entity or organization expected to pay the greatest share of the patient's bill
  * 01 = Medicare
  * 02 = Medi-Cal
  * 03 = Private Coverage
  * 04 = Workers' Compensation
  * 05 = County Indigent Programs
  * 06 = Other government
  * 07 = Other indigent
  * 08 = Self pay
  * 09 = Other payer
  * 00 = Invalid/blank
* pay_type = indicates type of coverage (not reported for other indigent, self pay, or other payer)
  * 0 = Not Applicable
  * 1 = Managed Care-Knox-Keene/Medi-Cal County Organized Health System
  * 2 = Managed Care - Other
  * 3 = Traditional Coverage
Demographic Variables:
* admtyr = year of admission
* patcnty = patient's county of residence (based on reported zip code)
* patzip = patient's reported zip code
* sex = patient's reported gender
  * . = Invalid
  * 1 = Male
  * 2 = Female
  * 3 = Other
  * 4 = Unknown
* agyrdsch = age of the patient at discharge (based on reported discharge date and patient's date of birth. If DOB is unknown/invalid, age is set to 0; max age assigned is 120 years)
* race_grp = normalized race group for a patient based on a combination (merged) or their reported race and ethnicity. 
  * 0 = Unknown/invalid/blank
  * 1 = White
  * 2 = Black
  * 3 = Hispanic
  * 4 = Asian/Pacific Islander
  * 5 = Native American/Eskimo/Aleut
  * 6 = Other
```{r reading in OSHPD 2016 PDD data, subsetting}
oshpdHD0  <- read_sas("S:\\CDCB\\Demonstration Folder\\Data\\OSHPD\\PDD\\2016\\cdph_pdd_ssn2016.sas7bdat") 

oshpdHD1   <- select(oshpdHD0,diag_p, odiag1, odiag2, odiag3, odiag4, odiag5, odiag6, odiag7, odiag8, odiag9, odiag19, odiag11, odiag12, odiag13, odiag14, odiag15, odiag16, odiag17, odiag18, odiag19, odiag20, odiag21, odiag22, odiag23, odiag24, mdc, charge, pay_cat, pay_type, admtyr, patcnty, patzip, sex, agyrdsch, race_grp)
```

Now, create RDS file of osdhpdH1
```{r saving OSHPD data as rds file}
#saving rds file--only needs to be run once to initially create the file
saveRDS(oshpdHD1, file=path(upPlace,"upData/oshpdHD2016_subset.rds"))
```


#Start code here if OSHPD 2016 subset has already been created:
```{r loading oshpd rds file into R}
oshpd16_subset <- readRDS(file=path(upPlace,"upData/oshpdHD2016_subset.rds")) #creating an rds file of oshpdHD, which is the subset of OSHPD data with only the selected variables
```


#MDC charge analysis
Groups by mdc variable and counts the number of hospitalizations with that mdc as well as the total charge for each mdc
```{r creating tWork file, MDC charge summary}
tWork   <- oshpd16_subset %>% mutate(mdc = as.numeric(mdc)) %>%
  group_by(mdc) %>%
  summarise(tCount = n(),
            tBucks = sum(charge)) %>%
  gather(tCount, tBucks, key = "count_charges", value = "number")

#This is the codebook for MDC numbers and the associated condiitons
oshpdMdcMap <- read_excel(path(myPlace,"myInfo/App_I_MDC_PDD.xlsx"), sheet="v32.0 ",skip=4)
#Renaming columns 1 and 2
names(oshpdMdcMap)[1] <- "mdc"
names(oshpdMdcMap)[2] <- "MDC"

#Joining tWork dataset above with the MDC codebook, removing the mdc column, saving as dataframe
tWork <- full_join(oshpdMdcMap,tWork,by="mdc")
tWork <- tWork %>% select(-mdc)
tWork <- as.data.frame((tWork))


#plotting the number of visits and the total charges for each MDC
ggplot(data = tWork, aes(x = MDC, y = number, fill = count_charges)) +  coord_flip() +
  geom_bar(stat = "identity" ) + 
  facet_grid(. ~ count_charges,scales="free_x")

```





#OSHPD Hospitalization primary and any diagnoses analysis

```{r reading in gbd.ICD.excel file}
icd_map <- read_excel(path(myPlace, "myInfo/gbd.ICD.Map.xlsx"))


```

